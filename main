#!/bin/bash
#PBS -l nodes=1:ppn=8,vmem=16gb,walltime=02:00:00
#PBS -N BROCCOLI
#PBS -V

set -e
set -x

mkdir -p output

#convert input into bids
bl2bids

sub=$(jq -r "._inputs[0].meta.subject" config.json | tr -d "_")
if [[ -z $sub || $sub == null ]]; then
    sub=0
fi

time singularity run --nv -e \
  -B `pwd`/bids:/bids \
  -B `pwd`/output:/output \
  docker://bids/broccoli:v1.0.0 \
  /bids /output participant --participant_label $sub

#fslmaths '/N/project/plab/giulia/data/output_broccoli/sub-01_tscores_contrast0001_MNI.nii' -thr 5 '/N/project/plab/giulia/data/output_broccoli/sub-01_tscores_contrast0001_MNI_thresholded.nii'


tscores=output/sub-${sub}/rhymejudgment/sub-${sub}_tscores_contrast0001_MNI.nii

singularity exec -e docker://brainlife/fsl:6.0.4 fslmaths $tscores -thr 5 output/sub-${sub}/activation_map_MNI.nii.gz

